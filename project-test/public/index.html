<!DOCTYPE html>
<html lang="en" x-data="auth()" x-init="initializeAuth()">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Book Catalogue</title>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <link rel="stylesheet" href="/css/book.css">
    <link rel="stylesheet" href="/css/main.css">
</head>
<body>
    <h1>Bookpedia</h1>

    <div x-data="{ username: localStorage.getItem('username') }" class="greet">
        <h2>Welcome, <span x-show="isAdmin" x-text="username" class="username"></span></h2>
        <!-- Logout button -->
        <button type="button" x-show="isAdmin" x-on:click="logout()" id="logoutBtn">Logout</button>
    </div>

    <div x-data="booksData()">
        <div class="manageBook">
            <div>
                <!-- Button to toggle add new book form -->
                <button type="button" x-show="isAdmin" @click="toggleAddBookForm()">Add New Book</button>
                <!-- Button to toggle manage book functionality -->
                <button type="button" x-show="isAdmin" @click="toggleManageBooks()">Manage Books</button>
                </div>

        <!-- Add New Book Form -->
        <div x-show="showAddBookForm && isAdmin" class="addForm">
            <div class="addItem">
                <h3>Add New Book</h3>
                    <form @submit.prevent="addBook">
                        <label for="title">Title:</label>
                        <input type="text" id="title" x-model="newBook.title" required><br>
                        <label for="author">Author:</label>
                        <input type="text" id="author" x-model="newBook.author" required><br>
                        <label for="genre">Genre:</label>
                        <input type="text" id="genre" x-model="newBook.genre" required><br>
                        <!-- Input field to select the cover image -->
                        <input type="file" @change="handleFileChange($event)" accept="image/*" required><br>
                        <button type="submit">Add Book</button>
                        <!-- Button to cancel adding a new book -->
                        <button type="button" @click="cancelAddBook">Cancel</button>
                    </form>
            </div>
            <div class="addItem">
                <h3>Preview</h3>
                <!-- Preview the cover image if selected -->
                <img :src="newBook.cover ? URL.createObjectURL(newBook.cover) : 'uploads/placeholder.png'" alt="New Book Cover" class="bookCover" x-show="newBook.cover"><br>
                <div class="bookInfo">
                Title: <span class="bookTitle" x-text="newBook.title"></span><br>
                Author: <span class="bookAuthor" x-text="newBook.author"></span><br>
                Genre: <span class="bookGenre" x-text="newBook.genre"></span><br>
                </div>
            </div>
        </div>
        </div>
        
        
        <!-- Book Search -->
        <h2>Book Search</h2>
        <form x-on:submit.prevent="searchBooks">
            <input type="text" x-model="searchTerm" @input="searchBooks" placeholder="Search by title or author or genre">
            <button type="button" @click="clearSearch()">Reset Search</button>
        </form>
        <div x-show="searchedBooks.length === 0 && searchTerm.length > 0">
            <p>No books found</p>
        </div>
        <div x-show="searchedBooks.length > 0 && searchTerm.length > 0"> 
            <h2>Search Results</h2>
            <div>
                <h3>You searched for: <span x-text="searchTerm"></span></h3>
            </div>
            <div>
                <h3>Search Results: <span x-text="searchedBooks.length"></span></h3>
            </div>
            <ul class="bookList">
                <template x-for="book in searchedBooks" :key="book.uuid">
                    <li>
                        <div class="bookContainer">
                            <div class="bookItem">
                                <img :src="getCoverPath(book.cover)" class="bookCover" alt="Book Cover">
                                <div class="bookInfo">
                                    <span class="bookTitle" x-text="book.title"></span> by <span class="bookAuthor" x-text="book.author"></span> 
                                    (<span class="bookGenre" x-text="book.genre"></span>)
                                </div>
                            </div>
                            <div x-show="showManageBooks && isAdmin" class="manageContainer">
                                <div x-show="isAdmin">
                                    <button @click="toggleEditForm(book)">Edit</button>
                                    <button @click="deleteBook(book)">Delete</button>
                                </div>
                                <!-- // Display the edit form when book.isEditing is true -->
                                <div x-show="book.isEditing && isAdmin">
                                    <form @submit.prevent="updateBook(book)">
                                        <label for="title">Title:</label>
                                        <input type="text" id="title" x-model="book.title" required><br>
                                        <label for="author">Author:</label>
                                        <input type="text" id="author" x-model="book.author" required><br>
                                        <label for="genre">Genre:</label>
                                        <input type="text" id="genre" x-model="book.genre" required><br>
                                        <label for="cover">New Cover:</label>
                                        <input type="file" id="coverInput" @change="handleFileChangeEdit($event)" accept="image/*"><br>
                                        <button type="submit">Update Book</button>
                                        <button type="button" @click="cancelEdit(book)">Cancel</button>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </li>
                </template>
            </ul>        
        </div>

        <!-- // Display All Books -->
        <div x-init="fetchBooks" x-show="books.length > 0 && !searchTerm.trim()">
            <h2>All Books</h2>
            <ul class="bookList">
                <template x-for="book in books" :key="book.uuid">
                    <li>
                        <div class="bookContainer">
                            <div class="bookItem">
                                <img :src="getCoverPath(book.cover)" alt="Book Cover" class="bookCover">
                                <div class="bookInfo">
                                    <span class="bookTitle" x-text="book.title"></span> by <span class="bookAuthor" x-text="book.author"></span> 
                                    (<span class="bookGenre" x-text="book.genre"></span>)
                                </div>
                            </div>
                            <div x-show="showManageBooks && isAdmin" class="manageContainer">
                                <div x-show="isAdmin">
                                    <button @click="toggleEditForm(book)">Edit</button>
                                    <button @click="deleteBook(book)">Delete</button>
                                <!-- Display the edit form when book.isEditing is true -->
                                <div x-show="book.isEditing && isAdmin">
                                    <form @submit.prevent="updateBook(book)">
                                        <label for="title">Title:</label>
                                        <input type="text" id="title" x-model="book.title" required><br>
                                        <label for="author">Author:</label>
                                        <input type="text" id="author" x-model="book.author" required><br>
                                        <label for="genre">Genre:</label>
                                        <input type="text" id="genre" x-model="book.genre" required><br>
                                        <label for="cover">New Cover:</label>
                                        <input type="file" id="coverInput" @change="handleFileChangeEdit($event)" accept="image/*">
                                        <button type="submit">Update Book</button>
                                        <button type="button" @click="cancelEdit(book)">Cancel</button>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </li>
                </template>
            </ul>            
        </div>
    </div>

    <script src="app.js"></script>
    <script src="manageBook.js"></script>
</body>
</html>
